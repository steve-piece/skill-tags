#!/usr/bin/env node
// bin/skill-tags.js
// CLI entry point for skill-tags.

'use strict';

const { spawnSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const VERSION = require('../package.json').version;
const SYNC_SCRIPT = path.join(__dirname, '..', 'sync.sh');

// ─── --version ───────────────────────────────────────────────────────────────

if (process.argv.includes('--version') || process.argv.includes('-v')) {
  console.log(`skill-tags v${VERSION}`);
  process.exit(0);
}

// ─── Windows guard ───────────────────────────────────────────────────────────

if (process.platform === 'win32') {
  console.error('\n  skill-tags requires bash and is not supported on Windows.');
  console.error('  Consider using WSL (Windows Subsystem for Linux) instead.\n');
  process.exit(1);
}

// ─── --help ──────────────────────────────────────────────────────────────────

if (process.argv.includes('--help') || process.argv.includes('-h')) {
  console.log(`
  skill-tags v${VERSION} — Cursor Skill Command Sync

  Usage: skill-tags [options]

  Options:
    (none)            Scan all skill sources and generate skill-tags.md
    --categories      Interactive category wizard (arrow keys + space to toggle)
    --categories --local  Category wizard for project-level skills only
    --global          Skip local skills (.agents/skills in CWD); scan global sources only
    --local           Scan only .agents/skills in CWD; write to .cursor/commands/project-skill-tags.md
    --setup           Interactive setup: choose Global (shell profile) or Project (package.json)
    --latest          Update skill-tags to the latest version
    --version, -v     Print version
    --help, -h        Show this help

  Skill sources (priority order):
    ~/.agents/skills/              skills installed via npx skills add
    ~/.cursor/skills-cursor/       Cursor built-in skills
    ~/.cursor/plugins/cache/       Cursor Marketplace plugin skills
    ~/.claude/plugins/cache/       Claude plugin skills
    ~/.codex/skills/               Codex skills
    ./.agents/skills/              project-level skills (current directory)

  Output:
    ~/.cursor/commands/skill-tags.md           full index of all skills (global)
    ~/.cursor/commands/skills-<category>.md    generated by --categories
    ./.cursor/commands/project-skill-tags.md   generated by --local
    ./.cursor/commands/skills-<category>.md    generated by --categories --local

  Config:
    ~/.cursor/skill-tags-categories.conf       global category config
    ./.cursor/skill-tags-categories.conf       project category config (--categories --local)

  Setup modes:
    Global   Adds skills() wrapper to ~/.zshrc — use: skills add <pkg>
    Project  Adds "skills": "st-skills" to package.json — use: npm run skills add <pkg>

  Project binary (st-skills):
    st-skills add <pkg>      Install a project skill and auto-sync
    st-skills remove <pkg>   Remove a project skill and auto-sync
    st-skills update <pkg>   Update a project skill and auto-sync
`);
  process.exit(0);
}

// ─── --categories ────────────────────────────────────────────────────────────

if (process.argv.includes('--categories')) {
  require('./categories');
}

// ─── --latest ────────────────────────────────────────────────────────────────

else if (process.argv.includes('--latest')) {
  const https = require('https');

  function getLatestVersion() {
    return new Promise((resolve, reject) => {
      https.get('https://registry.npmjs.org/skill-tags/latest', { headers: { Accept: 'application/json' } }, res => {
        let data = '';
        res.on('data', chunk => { data += chunk; });
        res.on('end', () => {
          try { resolve(JSON.parse(data).version); }
          catch { reject(new Error('Failed to parse registry response')); }
        });
      }).on('error', reject);
    });
  }

  (async () => {
    console.log(`\n  skill-tags v${VERSION}\n`);

    let latest;
    try {
      process.stdout.write('  Checking for updates...');
      latest = await getLatestVersion();
      process.stdout.write(` v${latest}\n`);
    } catch (err) {
      console.error(`\n  Could not reach npm registry: ${err.message}\n`);
      process.exit(1);
    }

    if (latest === VERSION) {
      console.log('  Already on the latest version.\n');
      process.exit(0);
    }

    console.log(`  Updating: v${VERSION} → v${latest}\n`);
    const result = spawnSync('npm', ['install', '-g', 'skill-tags@latest'], {
      stdio: 'inherit',
      shell: true,
    });

    if (result.error) {
      console.error(`\n  Update failed: ${result.error.message}`);
      console.error('  Try manually: npm install -g skill-tags@latest\n');
      process.exit(1);
    }

    if (result.status !== 0) {
      console.error('\n  Update failed. You may need to run with sudo:');
      console.error('  sudo npm install -g skill-tags@latest\n');
      process.exit(result.status);
    }

    console.log(`\n  ✓ Updated to v${latest}\n`);
  })();
}

// ─── --setup ─────────────────────────────────────────────────────────────────

else if (process.argv.includes('--setup')) {
  const runSetup = require('./setup');
  runSetup().catch(err => {
    if (err.name === 'ExitPromptError') { console.log(); process.exit(0); }
    console.error('  Error:', err.message);
    process.exit(1);
  });
}

// ─── Default: sync ───────────────────────────────────────────────────────────

else {
  if (!fs.existsSync(SYNC_SCRIPT)) {
    console.error(`\n  skill-tags: sync.sh not found at ${SYNC_SCRIPT}`);
    console.error('  Try reinstalling: npm install -g skill-tags\n');
    process.exit(1);
  }

  const args = process.argv.slice(2);
  const result = spawnSync('bash', [SYNC_SCRIPT, ...args], { stdio: 'inherit' });

  if (result.error) {
    console.error(`\n  skill-tags: failed to run bash — ${result.error.message}\n`);
    process.exit(1);
  }

  process.exit(result.status ?? 0);
}
