#!/usr/bin/env node
// bin/skill-tags.js
// CLI entry point for skill-tags.

'use strict';

const { spawnSync } = require('child_process');
const path = require('path');
const fs = require('fs');
const os = require('os');

const VERSION = require('../package.json').version;
const HOME = os.homedir();
const SYNC_SCRIPT = path.join(__dirname, '..', 'sync.sh');
const WRAPPER_MARKER = '# ─── skill-tags / Cursor Skill Command Sync';

// ─── --version ───────────────────────────────────────────────────────────────

if (process.argv.includes('--version') || process.argv.includes('-v')) {
  console.log(`skill-tags v${VERSION}`);
  process.exit(0);
}

// ─── Windows guard ───────────────────────────────────────────────────────────

if (process.platform === 'win32') {
  console.error('\n  skill-tags requires bash and is not supported on Windows.');
  console.error('  Consider using WSL (Windows Subsystem for Linux) instead.\n');
  process.exit(1);
}

// ─── --help ──────────────────────────────────────────────────────────────────

if (process.argv.includes('--help') || process.argv.includes('-h')) {
  console.log(`
  skill-tags v${VERSION} — Cursor Skill Command Sync

  Usage: skill-tags [options]

  Options:
    (none)            Scan all skill sources and generate skill-tags.md
    --categories      Interactive category wizard (arrow keys + space to toggle)
    --global-only     Skip project-level skills (.agents/skills in CWD)
    --project-only    Scan only .agents/skills in CWD; write to .cursor/commands/skill-tags.md
    --setup           Install the skills() shell wrapper in your shell rc
    --version, -v     Print version
    --help, -h        Show this help

  Skill sources (priority order):
    ~/.agents/skills/              skills installed via npx skills add
    ~/.cursor/skills-cursor/       Cursor built-in skills
    ~/.cursor/plugins/cache/       Cursor Marketplace plugin skills
    ~/.claude/plugins/cache/       Claude plugin skills
    ~/.codex/skills/               Codex skills
    ./.agents/skills/              project-level skills (current directory)

  Output:
    ~/.cursor/commands/skill-tags.md          full index of all skills
    ~/.cursor/commands/skills-<category>.md   generated by --categories
    ./.cursor/commands/skill-tags.md          generated by --project-only

  Config:
    ~/.cursor/skill-tags-categories.conf
`);
  process.exit(0);
}

// ─── --categories ────────────────────────────────────────────────────────────

if (process.argv.includes('--categories')) {
  require('./categories');
}

// ─── --setup ─────────────────────────────────────────────────────────────────

else if (process.argv.includes('--setup')) {
  runSetup().catch(err => {
    if (err.name === 'ExitPromptError') { console.log(); process.exit(0); }
    console.error('  Error:', err.message);
    process.exit(1);
  });
}

// ─── Default: sync ───────────────────────────────────────────────────────────

else {
  if (!fs.existsSync(SYNC_SCRIPT)) {
    console.error(`\n  skill-tags: sync.sh not found at ${SYNC_SCRIPT}`);
    console.error('  Try reinstalling: npm install -g skill-tags\n');
    process.exit(1);
  }

  const args = process.argv.slice(2);
  const result = spawnSync('bash', [SYNC_SCRIPT, ...args], { stdio: 'inherit' });

  if (result.error) {
    console.error(`\n  skill-tags: failed to run bash — ${result.error.message}\n`);
    process.exit(1);
  }

  process.exit(result.status ?? 0);
}

// ─── Setup implementation ────────────────────────────────────────────────────

async function runSetup() {
  const { confirm } = require('@inquirer/prompts');

  const shellName = path.basename(process.env.SHELL || 'bash');
  let rcFile;
  if (shellName === 'zsh') rcFile = path.join(HOME, '.zshrc');
  else if (process.platform === 'darwin') rcFile = path.join(HOME, '.bash_profile');
  else rcFile = path.join(HOME, '.bashrc');

  const displayRc = rcFile.replace(HOME, '~');

  console.log(`\n  skill-tags: shell setup\n`);

  let alreadyInstalled = false;
  try {
    const content = fs.readFileSync(rcFile, 'utf-8');
    if (content.includes(WRAPPER_MARKER)) alreadyInstalled = true;
  } catch {}

  if (alreadyInstalled) {
    console.log(`  ✓ Shell wrapper already installed in ${displayRc}\n`);
    process.exit(0);
  }

  console.log(`  This will add a skills() shell wrapper to ${displayRc}`);
  console.log(`  It auto-syncs skill-tags.md after every skills add/remove.\n`);

  const yes = await confirm({
    message: `Add the wrapper to ${displayRc}?`,
    default: true,
  });

  if (!yes) {
    console.log('\n  Skipped.\n');
    process.exit(0);
  }

  const syncPath = fs.existsSync(path.join(HOME, '.cursor', 'sync-skill-commands.sh'))
    ? path.join(HOME, '.cursor', 'sync-skill-commands.sh')
    : SYNC_SCRIPT;

  const wrapper = `
${WRAPPER_MARKER} ────────────────────────────────────────────────
# Wraps \`npx skills\` to auto-generate skill-tags.md after install/removal.
# Run manually: skill-tags   (or: bash ${syncPath})
function skills() {
  npx skills "$@"
  local exit_code=$?
  if [[ "$1" == "add" || "$1" == "remove" ]] && [[ $exit_code -eq 0 ]]; then
    bash "${syncPath}"
  fi
  return $exit_code
}
# ─────────────────────────────────────────────────────────────────────────────
`;

  try {
    fs.appendFileSync(rcFile, wrapper);
  } catch (err) {
    console.error(`\n  Failed to write to ${displayRc}: ${err.message}\n`);
    process.exit(1);
  }

  console.log(`\n  ✓ Added skills() wrapper to ${displayRc}`);
  console.log(`  Reload with: source ${displayRc}\n`);
}
